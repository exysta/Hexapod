<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>Servo Calibration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style type="text/css">
    body {
      font-family: Arial, sans-serif;
      background-color: #fafafa;
      margin: 0;
    }
    .title {
      text-align: center;
      position: relative;
      font-size: 32px;
      margin: 20px 0;
      color: #333;
    }
    
    .quantity {
      width: 40px;
      height: 28px;
      text-align: center;
      font-size: 14px;
    }
    
    button, input[type="button"] {
      color: black;
      background: lightblue;
      border: 1px solid #999;
      border-radius: 3px;
      cursor: pointer;
    }
    
    button:hover, input[type="button"]:hover {
      background: #87CEEB;
    }
    
    .control-buttons {
      text-align: center;
      margin: 20px 0;
    }
    
    .control-buttons button {
      width: 200px;
      height: 40px;
      margin: 0 10px;
      font-size: 16px;
      font-weight: bold;
    }
    
    .leg-group {
      display: inline-block;
      margin: 6px;
      padding: 5px;
      border: 1px solid #fc0;
      border-radius: 6px;
      background-color: #fffaf0;
      vertical-align: top;
      white-space: nowrap;
      box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
    }
    
    .leg-label {
      display: block;
      font-weight: bold;
      font-size: 13px;
      margin-bottom: 5px;
      color: #333;
      text-align: center;
      border-bottom: 1px solid #ebdcb2;
      padding-bottom: 3px;
    }
    
    .joint-control {
      display: inline-block;
      margin: 2px;
      padding: 2px;
      text-align: center;
    }
    
    .joint-label {
      display: block;
      font-size: 11px;
      color: #666;
      margin-bottom: 2px;
    }
    
    input[type="button"] {
      width: 26px;
      height: 26px;
      font-size: 16px;
      font-weight: bold;
    }
    
    .calibration-container {
      text-align: center;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .row {
      margin: 10px 0;
      white-space: nowrap;
      overflow-x: auto;
    }
    
    /* Mobile Adapter */
    @media (max-width: 768px) {
      .leg-group {
        margin: 4px;
        padding: 4px;
      } 
      .quantity {
        width: 30px;
      }
    }

    /* Footer */
    .footer {
      margin-top: 40px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-align: center;
      border-radius: 10px 10px 0 0;
      box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1);
    }
    .footer-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .footer-links {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .footer-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: white;
      text-decoration: none;
      font-size: 14px;
      padding: 5px 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      transition: all 0.3s;
    }
    .footer-link:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
    .footer-icon {
      width: 20px;
      height: 20px;
    }
  </style>
</head>
<body>
  <h1 class="title">Servo Calibration</h1>

  <div class="calibration-container">
    <div class="control-buttons">
      <button id="CALIBRATESTART" type="button" onclick="sendCalAction('start')">Start Calibration</button>
      <a href="/">
        <button id="CALIBRATESAVE" type="button" onclick="sendCalAction('save')">Save & Return</button>
      </a>
    </div>

    <!-- Front Legs -->
    <div class="row">
      <!--Left Frontal Leg 5-->
      <span class="leg-group">
        <span class="leg-label">Left Front (5)</span>
        <span class="joint-control">
          <span class="joint-label">Joint 0</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(5, 0, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
        <span class="joint-control">
          <span class="joint-label">Joint 1</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(5, 1, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
        <span class="joint-control">
          <span class="joint-label">Joint 2</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(5, 2, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
      </span>
      
      <!--Right Frontal Leg 0-->
      <span class="leg-group">
        <span class="leg-label">Right Front (0)</span>
        <span class="joint-control">
          <span class="joint-label">Joint 0</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(0, 0, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
        <span class="joint-control">
          <span class="joint-label">Joint 1</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(0, 1, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
        <span class="joint-control">
          <span class="joint-label">Joint 2</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(0, 2, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
      </span>
    </div>

    <!-- Middle Legs -->
    <div class="row">
      <!--Left Middle Leg 4-->
      <span class="leg-group">
        <span class="leg-label">Left Middle (4)</span>
        <span class="joint-control">
          <span class="joint-label">Joint 0</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(4, 0, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
        <span class="joint-control">
          <span class="joint-label">Joint 1</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(4, 1, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
        <span class="joint-control">
          <span class="joint-label">Joint 2</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(4, 2, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
      </span>
      
      <!--Right Middle Leg 1-->
      <span class="leg-group">
        <span class="leg-label">Right Middle (1)</span>
        <span class="joint-control">
          <span class="joint-label">Joint 0</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(1, 0, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
        <span class="joint-control">
          <span class="joint-label">Joint 1</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(1, 1, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
        <span class="joint-control">
          <span class="joint-label">Joint 2</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(1, 2, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
      </span>
    </div>

    <!-- Back Legs -->
    <div class="row">
      <!--Left Back Leg 3-->
      <span class="leg-group">
        <span class="leg-label">Left Back (3)</span>
        <span class="joint-control">
          <span class="joint-label">Joint 0</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(3, 0, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
        <span class="joint-control">
          <span class="joint-label">Joint 1</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(3, 1, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
        <span class="joint-control">
          <span class="joint-label">Joint 2</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(3, 2, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
      </span>
      
      <!--Right Back Leg 2-->
      <span class="leg-group">
        <span class="leg-label">Right Back (2)</span>
        <span class="joint-control">
          <span class="joint-label">Joint 0</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(2, 0, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
        <span class="joint-control">
          <span class="joint-label">Joint 1</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(2, 1, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
        <span class="joint-control">
          <span class="joint-label">Joint 2</span>
          <input type="button" class="decrease" value="-"> 
          <input type="text" class="quantity" value="0" onchange="sendData(2, 2, event.target.value)"/> 
          <input type="button" class="increase" value="+">
        </span>
      </span>
    </div>
  </div>


<script>
// --- WebSocket Setup ---
var gateway = `ws://${window.location.hostname}/cmd`;
var websocket;

window.onload = function() {
    initWebSocket();
};

function initWebSocket() {
    websocket = new WebSocket(gateway);
    websocket.onopen = function(event) {
        console.log('Connected to WebSocket');
    };
    websocket.onclose = function(event) {
        console.log('WebSocket Closed, retrying...');
        setTimeout(initWebSocket, 2000);
    };
    websocket.onmessage = function(event) {
        console.log("RX:", event.data);
    };
}

// --- UI Logic for + / - buttons ---
let increment = document.getElementsByClassName("increase");
for (let i = 0; i < increment.length; i++) {
  increment[i].index = i;
  increment[i].onclick = function () {
      let flag = this.index;
      let q = document.getElementsByClassName("quantity")[flag];
      let newValue = parseInt(q.value) + 1;
      q.value = newValue; // Update visual
      q.setAttribute('value', newValue); // Update DOM attribute

      sendDataByIndex(i, newValue);
  }
}

let decrement = document.getElementsByClassName('decrease');
for(let j = 0; j < decrement.length; j++) {
  decrement[j].index = j;
  decrement[j].onclick = function() {
      let flag = this.index;
      let q = document.getElementsByClassName("quantity")[flag];
      let newValue = parseInt(q.value) - 1;
      q.value = newValue;
      q.setAttribute('value', newValue);

      sendDataByIndex(j, newValue);
  }
}

function sendDataByIndex(id, newValue) {
  let legIndex;
  let partIndex = id % 3;
  let legOrder = Math.floor((id) / 3);

  // Map the visual layout order to the physical leg IDs
  switch (legOrder) {
    case 0: legIndex = 5; break; // Left Front
    case 1: legIndex = 0; break; // Right Front
    case 2: legIndex = 4; break; // Left Middle
    case 3: legIndex = 1; break; // Right Middle
    case 4: legIndex = 3; break; // Left Back
    case 5: legIndex = 2; break; // Right Back
  }

  sendData(legIndex, partIndex, newValue);
}

// Send Offset Update via WebSocket
function sendData(legIndex, partIndex, offset) {
  var intOffset = parseInt(offset, 10);

  if (websocket && websocket.readyState === WebSocket.OPEN) {
    // Protocol: {"cal_action": "offset", "leg": 5, "part": 0, "val": 10}
    var data = {
        cal_action: "offset",
        leg: legIndex,
        part: partIndex,
        val: intOffset
    };
    websocket.send(JSON.stringify(data));
    console.log("Sent Offset:", data);
  } else {
    console.log("WebSocket not ready");
  }
}

// Send Start/Save commands
function sendCalAction(actionName) {
  if (websocket && websocket.readyState === WebSocket.OPEN) {
    var data = {
        cal_action: actionName // "start" or "save"
    };
    websocket.send(JSON.stringify(data));
    console.log("Sent Action:", data);
  } else {
    alert("Not connected to robot!");
  }
}
</script>
</body>
</html>